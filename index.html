<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Monitoring Material Return Gudang</title>
  <base target="_top">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      padding: 2rem;
    }

    h1, h2 {
      color: #2c3e50;
    }

    .nav-tabs .nav-link.active {
      background-color: #007bff;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.75rem;
      vertical-align: top;
      border-top: 1px solid #dee2e6;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    tbody tr:hover {
      background-color: #f1f1f1;
    }

    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
      font-size: 1.25rem;
      color: #6c757d;
    }

    .form-control:focus,
    .form-select:focus {
      box-shadow: none;
      border-color: #007bff;
    }

    /* Modal styles */
    .modal-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 1040;
      display: none;
    }

    .modal-custom {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 0.3rem;
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
      z-index: 1050;
      width: 100%;
      max-width: 600px;
      display: none;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: #2c3e50;
    }

    .modal-body {
      padding: 1rem 1.5rem;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #dee2e6;
      text-align: right;
    }

    .btn-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      line-height: 1;
      color: #000;
      opacity: 0.5;
      cursor: pointer;
    }

    .btn-close:hover {
      opacity: 0.75;
    }
   
    /* Membuat tabel bisa scroll horizontal di layar kecil */
    .table-responsive {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* untuk smooth scrolling di iOS */
    }   

  </style>
</head>
<body>

<div class="container">
  <h1 class="text-center mb-4">ðŸ“¦ Monitoring Material Return Gudang</h1>

  <!-- Tab Navigation -->
  

  <div class="d-flex justify-content-center gap-3 my-4">
    <button class="btn btn-primary" id="openAddReturnBtn">Tambah Data IR</button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content card shadow-sm p-4 mt-3" id="myTabContent">

    <!-- Tab 3: Lihat Data -->
    <div class="tab-pane fade show active" id="data" role="tabpanel">
      <h3 class="mt-4 mb-3">Status IR Return ke Gudang</h3>
      <div id="sheet1Loader" class="loader">Memuat data...</div>
      <div id="sheet1TableContainer"></div>

      <h3 class="mt-5 mb-3">Status Detail Material</h3>
      <div id="sheet2Loader" class="loader">Memuat data...</div>
      <div id="sheet2TableContainer"></div>

      <h3 class="mt-5 mb-3">Update Laporan Data Material</h3>
      <div id="sheet3Loader" class="loader">Memuat data...</div>
      <div id="sheet3TableContainer"></div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div id="modalBackdrop" class="modal-backdrop"></div>

<!-- Modal Tambah Data Return -->
<div id="addReturnModal" class="modal-custom" role="dialog" aria-modal="true" aria-labelledby="addReturnTitle" tabindex="-1">
  <div class="modal-header">
    <h5 class="modal-title" id="addReturnTitle">Tambah Data IR</h5>
    <button type="button" class="btn-close" aria-label="Close" id="closeAddReturnModal">&times;</button>
  </div>
  <div class="modal-body">
    <form id="addDataForm">
      <div class="mb-3">
        <label for="nomorIR" class="form-label">Nomor IR</label>
        <input type="text" class="form-control" id="nomorIR" placeholder="Masukkan Nomor IR" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Detail Material</label>
        <table class="table table-bordered" id="materialDetails">
          <thead>
            <tr>
              <th>Stock Code</th>
              <th>Nama Material</th>
              <th>Jumlah</th>
              <th>Satuan</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" class="form-control" name="stockCode[]" required></td>
              <td><input type="text" class="form-control" name="namaMaterial[]" required></td>
              <td><input type="number" class="form-control" name="jumlah[]" required></td>
              <td><input type="text" class="form-control" name="satuan[]" required></td>
              <td><button type="button" class="btn btn-danger" onclick="removeMaterialRow(this)">Hapus</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-success mt-2" onclick="addMaterialRow()">Tambah Baris</button>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary w-100">Simpan Data</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Update Material -->
<div id="updateMaterialModal" class="modal-custom" role="dialog" aria-modal="true" aria-labelledby="updateMaterialTitle" tabindex="-1">
  <div class="modal-header">
    <h5 class="modal-title" id="updateMaterialTitle">Update Material</h5>
    <button type="button" class="btn-close" aria-label="Close" id="closeUpdateMaterialModal">&times;</button>
  </div>
  <div class="modal-body">
    <form id="updateSheet3Form">
      <div class="mb-3">
        <label for="irSelect" class="form-label">Nomor IR</label>
        <select id="irSelect" class="form-select" required>
          <option value="">-- Pilih Nomor IR --</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="materialSelect" class="form-label">Material</label>
        <select id="materialSelect" class="form-select" required>
          <option value="">-- Pilih Material --</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="jumlahUpdate" class="form-label">Jumlah</label>
        <input type="number" class="form-control" id="jumlahUpdate" min="1" required>
      </div>

      <div class="mb-3">
        <label for="keterangan" class="form-label">Keterangan</label>
        <input type="text" class="form-control" id="keterangan" required>
      </div>

      <div class="mb-3">
        <label for="evidenceFile" class="form-label">Upload Bukti (Evidence)</label>
        <input type="file" class="form-control" id="evidenceFile" accept="image/*" required>
        </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-warning w-100">Simpan Update</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="feedbackToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">
        <!-- Pesan akan muncul di sini -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>


<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Google Apps Script Integration -->
<script>
  function parseCustomTimestamp(timestampStr) {
  // Format input: "27/05/2025 11:40:19"
  const [datePart, timePart] = timestampStr.split(' ');
  const [day, month, year] = datePart.split('/');
  const [hours, minutes, seconds] = timePart.split(':');
  
  // Buat objek Date: new Date(year, monthIndex, day, hours, minutes, seconds)
  return new Date(year, parseInt(month) - 1, day, hours, minutes, seconds);
}
//memuat tabel
function createTable(data, sheetName) {
  if (!data || data.length === 0) return '<p class="text-muted">Tidak ada data ditemukan.</p>';
  
  const headers = data[0];
  let rows = data.slice(1);

  // Urutkan berdasarkan timestamp (kolom pertama) dari terbaru ke terlama
  if (sheetName === 'Sheet1' || sheetName === 'Sheet2' || sheetName === 'Sheet3') {
    rows.sort((a, b) => {
      const dateA = parseCustomTimestamp(a[0]); // Kolom pertama adalah timestamp
      const dateB = parseCustomTimestamp(b[0]);
      return dateB - dateA; // Descending order
    });
  }

  // Buat ID unik untuk tabel dan search input berdasarkan sheetName
  const tableId = sheetName + 'Table';
  const searchId = sheetName + 'Search';

  let tableHTML = `
    <div class="mb-3">
      <input type="text" class="form-control" id="${searchId}" placeholder="Cari di tabel ini...">
    </div>
    <table id="${tableId}" class="table table-striped table-bordered table-hover">
      <thead class="table-dark">
        <tr>
  `;

  headers.forEach((header, index) => { 
    tableHTML += `<th data-col-index="${index}" style="cursor:pointer;">${header} <span class="sort-indicator"></span></th>` 
  });
  if(sheetName === 'Sheet2') {
    tableHTML += '<th>Aksi</th>'; // Tambah kolom aksi untuk Sheet2
  }
  tableHTML += '</tr></thead><tbody>';

  rows.forEach((row, index) => {
    tableHTML += '<tr>';
    row.forEach((cell, cellIndex) => {
      if (sheetName === 'Sheet3' && cellIndex === 7 && cell.startsWith('http')) {
        tableHTML += `<td><a href="${cell}" target="_blank">Lihat Foto</a></td>`;
      } else {
        tableHTML += `<td>${cell}</td>`;
      }
    });

    if(sheetName === 'Sheet2') {
      const nomorIR = row[1];
      const stockCode = row[2];
      const namaMaterial = row[3];
      const satuan = row[5];
      const jumlahBon = Number(row[4]);
      const jumlahUpdated = Number(row[6]);
      const sisa = jumlahBon - jumlahUpdated;

      if (sisa <= 0) {
        tableHTML += `<td><span class="text-success fw-bold">Complete</span></td>`;
      } else {
        tableHTML += `<td><button class="btn btn-sm btn-warning" onclick='openUpdateModalFromTable(${JSON.stringify(nomorIR)}, ${JSON.stringify(stockCode)}, ${JSON.stringify(namaMaterial)}, ${JSON.stringify(satuan)}, ${jumlahBon}, ${jumlahUpdated})'>Update Material</button></td>`;
      }
    }
    tableHTML += '</tr>';
  });

  tableHTML += '</tbody></table>';
  return `<div class="table-responsive">${tableHTML}</div>`;

}

// Fungsi untuk menginisialisasi pencarian dan sorting pada tabel
function initTableFeatures(sheetName) {
  const searchInput = document.getElementById(sheetName + 'Search');
  const table = document.getElementById(sheetName + 'Table');
  if (!searchInput || !table) return;

  const tbody = table.tBodies[0];
  const headers = table.tHead.rows[0].cells;

  // Pencarian
  searchInput.addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    Array.from(tbody.rows).forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? '' : 'none';
    });
  });

  // Sorting
  Array.from(headers).forEach((header, index) => {
    header.addEventListener('click', () => {
      const currentIsAsc = header.classList.contains('asc');
      clearSortIndicators(headers);
      sortTableByColumn(table, index, !currentIsAsc);
      header.classList.toggle('asc', !currentIsAsc);
      header.classList.toggle('desc', currentIsAsc);
      updateSortIndicator(header, !currentIsAsc);
    });
  });
}

function clearSortIndicators(headers) {
  Array.from(headers).forEach(h => {
    h.classList.remove('asc', 'desc');
    const indicator = h.querySelector('.sort-indicator');
    if (indicator) indicator.textContent = '';
  });
}

function updateSortIndicator(header, asc) {
  const indicator = header.querySelector('.sort-indicator');
  if (indicator) indicator.textContent = asc ? ' â–²' : ' â–¼';
}

function sortTableByColumn(table, column, asc = true) {
  const dirModifier = asc ? 1 : -1;
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.querySelectorAll('tr'));

  // Tentukan apakah kolom berisi angka atau teks
  const isNumericColumn = rows.every(row => {
    const cellText = row.cells[column]?.textContent.trim();
    return !isNaN(cellText) && cellText !== '';
  });

  // Sort rows
  const sortedRows = rows.sort((a, b) => {
    let aText = a.cells[column]?.textContent.trim() || '';
    let bText = b.cells[column]?.textContent.trim() || '';

    if (isNumericColumn) {
      return dirModifier * (parseFloat(aText) - parseFloat(bText));
    } else {
      return dirModifier * aText.localeCompare(bText);
    }
  });

  // Hapus semua baris lama
  while (tbody.firstChild) {
    tbody.removeChild(tbody.firstChild);
  }

  // Tambahkan baris yang sudah diurutkan
  tbody.append(...sortedRows);
}


//Modal modal update dengan data terisi otomatis
function openUpdateModalFromTable(nomorIR, stockCode, namaMaterial, satuan, jumlahBon, jumlahUpdated) {
  openModal(updateMaterialModal);

  // Set nilai di modal update
  document.getElementById('irSelect').innerHTML = `<option value="${nomorIR}" selected>${nomorIR}</option>`;
  document.getElementById('irSelect').disabled = true; // disable agar tidak bisa ganti

  // Set materialSelect dengan satu option yang sudah dipilih
  const materialSelect = document.getElementById('materialSelect');
  materialSelect.innerHTML = '';
  const option = document.createElement('option');
  option.value = JSON.stringify({ stockCode, namaMaterial, satuan });
  option.textContent = `${stockCode} - ${namaMaterial} (${satuan})`;
  option.selected = true;
  materialSelect.appendChild(option);
  materialSelect.disabled = true; // disable agar tidak bisa ganti

  // Reset input lain
  const jumlahInput = document.getElementById('jumlahUpdate');
  jumlahInput.value = '';
  
  // Hitung max jumlah yang bisa diinput
  const maxJumlah = jumlahBon - jumlahUpdated;
  jumlahInput.max = maxJumlah > 0 ? maxJumlah : 0;
  jumlahInput.placeholder = `Maksimal: ${maxJumlah > 0 ? maxJumlah : 0}`;

  document.getElementById('keterangan').value = '';
  document.getElementById('evidenceFile').value = '';
}


  // Load data sheet
  function fetchData(sheetName, loaderId, containerId) {
  document.getElementById(loaderId).style.display = 'block';
  document.getElementById(containerId).innerHTML = '';
  google.script.run
    .withSuccessHandler(function(data) {
      document.getElementById(loaderId).style.display = 'none';
      document.getElementById(containerId).innerHTML = createTable(data, sheetName);
      initTableFeatures(sheetName);  // <-- Tambahkan ini
    })
    .withFailureHandler(function(err) {
      document.getElementById(loaderId).style.display = 'none';
      document.getElementById(containerId).innerHTML = `<div class="alert alert-danger">Gagal memuat data: ${err}</div>`;
    })
    ['get' + sheetName + 'Data']();
}


  // Modal controls
  const modalBackdrop = document.getElementById('modalBackdrop');
  const addReturnModal = document.getElementById('addReturnModal');
  const updateMaterialModal = document.getElementById('updateMaterialModal');

  function openModal(modal) {
    modalBackdrop.style.display = 'block';
    modal.style.display = 'block';
  }

  function closeModal(modal) {
    modalBackdrop.style.display = 'none';
    modal.style.display = 'none';
  }

  document.getElementById('openAddReturnBtn').addEventListener('click', () => {
    openModal(addReturnModal);
  });

  document.getElementById('closeAddReturnModal').addEventListener('click', () => {
    closeModal(addReturnModal);
  });

  //document.getElementById('openUpdateMaterialBtn').addEventListener('click', () => {
  //openModal(updateMaterialModal);
  //const irSelect = document.getElementById('irSelect');
  //irSelect.disabled = false;
  //irSelect.innerHTML = '<option value="">-- Pilih Nomor IR --</option>';
  //const materialSelect = document.getElementById('materialSelect');
  //materialSelect.disabled = false;
  //materialSelect.innerHTML = '<option value="">-- Pilih Material --</option>';
  //loadIRDropdown();
  //document.getElementById('updateSheet3Form').reset();
//});


  document.getElementById('closeUpdateMaterialModal').addEventListener('click', () => {
  closeModal(updateMaterialModal);
  // Enable kembali dropdown dan reset isinya
  const irSelect = document.getElementById('irSelect');
  irSelect.disabled = false;
  irSelect.innerHTML = '<option value="">-- Pilih Nomor IR --</option>';

  const materialSelect = document.getElementById('materialSelect');
  materialSelect.disabled = false;
  materialSelect.innerHTML = '<option value="">-- Pilih Material --</option>';

  document.getElementById('updateSheet3Form').reset();
});


  modalBackdrop.addEventListener('click', () => {
    closeModal(addReturnModal);
    closeModal(updateMaterialModal);
  });

  // Load daftar IR for update modal
  function loadIRDropdown() {
  const irSelect = document.getElementById('irSelect');
  irSelect.innerHTML = '<option value="">-- Pilih Nomor IR --</option>';
  google.script.run.withSuccessHandler(data => {
    // Ambil unique Nomor IR dari kolom B (index 1)
    const uniqueIRs = [...new Set(data.slice(1).map(row => row[1]))];
    uniqueIRs.forEach(ir => {
      const option = document.createElement('option');
      option.value = ir;
      option.textContent = ir;
      irSelect.appendChild(option);
    });
  }).getSheet2Data();
}

  // Isi dropdown material
  function populateMaterialDropdown(ir, data) {
  const materialSelect = document.getElementById('materialSelect');
  materialSelect.innerHTML = '<option value="">-- Pilih Material --</option>';

  console.log("Data diterima untuk dropdown:", data); // Debugging

  data.forEach(row => {
    // Pastikan baris bukan header
    if (row[1] === ir && row[3]) { // row[1] = Nomor IR, row[3] = Nama Material
      const stockCode = row[2];
      const namaMaterial = row[3];
      const satuan = row[5];
      const option = document.createElement('option');
      option.value = JSON.stringify({ stockCode, namaMaterial, satuan });
      option.textContent = `${stockCode} - ${namaMaterial} (${satuan})`;
      materialSelect.appendChild(option);
    }
  });

  if (materialSelect.children.length <= 1) {
    const option = document.createElement('option');
    option.value = "";
    option.textContent = "-- Tidak ada material --";
    materialSelect.appendChild(option);
  }
}

  document.getElementById('irSelect').addEventListener('change', () => {
  const selectedIR = document.getElementById('irSelect').value;
  const materialSelect = document.getElementById('materialSelect');
  materialSelect.innerHTML = '<option value="">-- Memuat... --</option>';

  if (selectedIR) {
    google.script.run
      .withSuccessHandler(materials => {
        console.log("Data materials diterima:", materials);

        if (!materials || materials.length === 0) {
          materialSelect.innerHTML = '<option value="">-- Tidak ada material --</option>';
          return;
        }

        materialSelect.innerHTML = '<option value="">-- Pilih Material --</option>';
        materials.slice(1).forEach(row => {
          const stockCode = row[2];
          const namaMaterial = row[3];
          const satuan = row[5];

          if (stockCode && namaMaterial && satuan) {
            const option = document.createElement('option');
            option.value = JSON.stringify({ stockCode, namaMaterial, satuan });
            option.textContent = `${stockCode} - ${namaMaterial} (${satuan})`;
            materialSelect.appendChild(option);
          }
        });
      })
      .withFailureHandler(err => {
        alert("Gagal memuat material: " + err);
        materialSelect.innerHTML = '<option value="">-- Gagal memuat --</option>';
      })
      .getSheet2DataByIR(selectedIR);
  } else {
    materialSelect.innerHTML = '<option value="">-- Pilih Material --</option>';
  }
});

  // Submit form tambah data
  document.getElementById('addDataForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`;

  const nomorIR = document.getElementById('nomorIR').value.trim();
  const rows = document.querySelectorAll('#materialDetails tbody tr');
  const materials = [];

  if (!nomorIR) {
    showToast('Nomor IR harus diisi.', false);
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  for (const row of rows) {
    const stockCode = row.querySelector('[name="stockCode[]"]').value.trim();
    const namaMaterial = row.querySelector('[name="namaMaterial[]"]').value.trim();
    const jumlah = row.querySelector('[name="jumlah[]"]').value.trim();
    const satuan = row.querySelector('[name="satuan[]"]').value.trim();

    if (!stockCode || !namaMaterial || !jumlah || !satuan) {
      showToast('Semua kolom material harus diisi.', false);
      btn.disabled = false;
      btn.textContent = originalText;
      return;
    }

    materials.push({
      stockCode: stockCode,
      namaMaterial: namaMaterial,
      jumlah: jumlah,
      satuan: satuan
    });
  }

  google.script.run
    .withSuccessHandler(() => {
      showToast('Data berhasil disimpan.', true);
      document.getElementById('nomorIR').value = '';
      document.querySelector('#materialDetails tbody').innerHTML = `
        <tr>
          <td><input type="text" class="form-control" name="stockCode[]" required></td>
          <td><input type="text" class="form-control" name="namaMaterial[]" required></td>
          <td><input type="number" class="form-control" name="jumlah[]" required></td>
          <td><input type="text" class="form-control" name="satuan[]" required></td>
          <td><button type="button" class="btn btn-danger" onclick="removeMaterialRow(this)">Hapus</button></td>
        </tr>
      `;
      fetchData('Sheet1', 'sheet1Loader', 'sheet1TableContainer');
      fetchData('Sheet2', 'sheet2Loader', 'sheet2TableContainer');
      closeModal(addReturnModal);
      btn.disabled = false;
      btn.textContent = originalText;
    })
    .withFailureHandler(err => {
      showToast('Gagal menyimpan data: ' + err, false);
      btn.disabled = false;
      btn.textContent = originalText;
    })
    .saveDataToSpreadsheet(nomorIR, materials);
});

  // Submit form update material
  document.getElementById('updateSheet3Form').addEventListener('submit', function(e) {
  e.preventDefault();
  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`;
  
const jumlahInput = document.getElementById('jumlahUpdate');
const maxJumlah = parseInt(jumlahInput.max, 10);
const jumlahValue = parseInt(jumlahInput.value, 10);

if (jumlahValue > maxJumlah) {
  alert(`Jumlah tidak boleh lebih dari maksimal ${maxJumlah}.`);
  return;
}
  console.log("Submit update material form triggered");
// Tambahkan ini:
  const now = getFullTimestamp();

  function getFullTimestamp() {
  const d = new Date();
  const pad = n => n < 10 ? '0' + n : n;
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
  const nomorIR = document.getElementById('irSelect').value;
  const materialVal = document.getElementById('materialSelect').value;
  if (!materialVal) {
    alert('Harap pilih material.');
    return;
  }
  const material = JSON.parse(materialVal);
  const jumlah = document.getElementById('jumlahUpdate').value;
  const keterangan = document.getElementById('keterangan').value.trim();
  const fileInput = document.getElementById('evidenceFile');

  // Validasi semua field
  if (!nomorIR || !material || !jumlah || !keterangan) {
    alert('Harap lengkapi semua field.');
    return;
  }

  // Jika ada file yang dipilih, unggah ke Google Drive
  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
      const dataUrl = e.target.result;

      if (!dataUrl || typeof dataUrl !== 'string' || !dataUrl.startsWith('data:image')) {
        showToast('Format file tidak valid. Harap pilih file gambar.', false);
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }

      google.script.run
        .withSuccessHandler(function(fileUrl) {
          saveDataToSheet3(now, nomorIR, material, jumlah, keterangan, fileUrl);
          btn.disabled = false;
          btn.textContent = originalText;
        })
        .withFailureHandler(function(err) {
          showToast('Gagal mengunggah file: ' + err, false);
          btn.disabled = false;
          btn.textContent = originalText;
        })
        .uploadFileToDrive(dataUrl, file.name);
    };

    reader.onerror = function() {
      showToast("Terjadi kesalahan saat membaca file.", false);
      btn.disabled = false;
      btn.textContent = originalText;
    };

    reader.readAsDataURL(file);
  } else {
    saveDataToSheet3(now, nomorIR, material, jumlah, keterangan, '');
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

function saveDataToSheet3(tanggal, nomorIR, material, jumlah, keterangan, evidenceUrl) {
  google.script.run
    .withSuccessHandler(() => {
      showToast('Data berhasil disimpan ke Sheet 3!', true);
      document.getElementById('updateSheet3Form').reset();
      document.getElementById('materialSelect').innerHTML = '<option value="">-- Pilih Material --</option>';
      fetchData('Sheet2', 'sheet2Loader', 'sheet2TableContainer');
      fetchData('Sheet3', 'sheet3Loader', 'sheet3TableContainer');
      closeModal(updateMaterialModal);
    })
    .withFailureHandler(err => {
      showToast('Gagal menyimpan data: ' + err, false);
    })
    .saveSheet3Data(
      tanggal,
      nomorIR,
      material.stockCode,
      material.namaMaterial,
      jumlah,
      material.satuan,
      keterangan,
      evidenceUrl || ''
    );
}

  // Fungsi tambah/hapus baris material
  function addMaterialRow() {
    const tbody = document.querySelector('#materialDetails tbody');
    const row = tbody.insertRow();
    row.innerHTML = `
      <td><input type="text" class="form-control" name="stockCode[]" required></td>
      <td><input type="text" class="form-control" name="namaMaterial[]" required></td>
      <td><input type="number" class="form-control" name="jumlah[]" required></td>
      <td><input type="text" class="form-control" name="satuan[]" required></td>
      <td><button type="button" class="btn btn-danger" onclick="removeMaterialRow(this)">Hapus</button></td>
    `;
  }

  function removeMaterialRow(btn) {
    btn.closest('tr').remove();
  }

  window.onload = function() {
    fetchData('Sheet1', 'sheet1Loader', 'sheet1TableContainer');
    fetchData('Sheet2', 'sheet2Loader', 'sheet2TableContainer');
    fetchData('Sheet3', 'sheet3Loader', 'sheet3TableContainer');
  };

  function showToast(message, isSuccess = true) {
  const toastEl = document.getElementById('feedbackToast');
  const toastMessage = document.getElementById('toastMessage');

  toastMessage.textContent = message;

  // Ganti warna background toast
  toastEl.classList.remove('bg-primary', 'bg-success', 'bg-danger');
  toastEl.classList.add(isSuccess ? 'bg-success' : 'bg-danger');

  const toast = new bootstrap.Toast(toastEl);
  toast.show();
}

</script>

</body>
</html>
